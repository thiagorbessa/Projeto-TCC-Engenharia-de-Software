<!DOCTYPE html>
<html lang="pt-br"
      xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.w3.org/1999/xhtml">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width"/>
    <title>Listar Pessoas</title>
    <link rel="stylesheet" th:href="@{/css/estilo.css}"/>
    <style>
        /* Centralizar campo de busca e botão */
        .busca-container {
            display: flex;
            justify-content: center;
            margin: 20px 0;
        }

        .busca-wrapper {
            display: flex;
            gap: 10px;
        }

        #busca {
            width: 400px;
            padding: 8px 12px;
            font-size: 14px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }

        #limpar-busca {
            align-self: center;
            text-decoration: none;
            color: purple;
            cursor: pointer;
        }

        .ver-mais {
            display: block;
            color: blue;
            font-size: 12px;
            cursor: pointer;
            text-decoration: underline;
        }
    </style>
</head>

<body>

<header>
    <nav>
        <ul>
            <li><a th:href="@{/}">Entrada e Saída</a></li>
            <li><a th:href="@{/pessoas}">Listar</a></li>
            <li><a th:href="@{/pessoas/novo}">Novo</a></li>
            <li sec:authorize="hasAnyRole('SISTEMA', 'GERAL')">
                <a th:href="@{/usuarios}"> Cadastro de Usuários </a>
            </li>

            <li sec:authorize="isAuthenticated()">
                <form th:action="@{/logout}" method="post" style="display:inline">
                    <button type="submit" style="background:none; border:none; color:white; cursor:pointer;">Sair</button>
                </form>
            </li>
        </ul>
    </nav>
</header>

<main>
    <section class="busca-container">
        <div class="busca-wrapper">
            <input type="text"
                   id="busca"
                   placeholder="Buscar por nome, CPF, RG ou telefone">

            <a href="#" id="limpar-busca">Limpar</a>
        </div>
    </section>

    <section>
        <h1>Lista de Pessoas</h1>
    </section>

    <section>
        <table>
            <thead>
            <tr>
                <th>Documento</th>
                <th>Nome</th>
                <th>Telefone</th>
                <th>Unidade</th>
                <th>Setor</th>
                <th>Andar</th>
                <th>Paciente</th>
                <th>Hora Entrada</th>
                <th>Hora Saída</th>
                <th>Ação</th>
                <th>Observação</th>
                <th>Histórico Pessoa</th>
                <th>Editar</th>
                <th sec:authorize="hasAnyRole('SISTEMA', 'GERAL')">Remover</th>
            </tr>
            </thead>

            <tbody id="tabela-pessoas" th:fragment="tabela">
            <tr th:each="pessoa : ${pessoas}"
                th:with="registroAberto=${registrosAbertos[pessoa.id]}">

                <td th:text="${#strings.isEmpty(pessoa.cpf) ? (#strings.isEmpty(pessoa.identidade) ? 'não preenchido' : pessoa.identidade) : pessoa.cpf}"></td>
                <td th:text="${pessoa.nome}"></td>
                <td th:text="${pessoa.telefone}"></td>
                <td th:text="${pessoa.unidade}"></td>
                <td th:text="${pessoa.setor}"></td>
                <td th:text="${pessoa.andar}"></td>
                <td th:text="${pessoa.paciente}"></td>

                <td th:text="${pessoa.registros.isEmpty() ? '-' : #temporals.format(pessoa.registros[0].horaEntrada, 'dd/MM/yyyy HH:mm')}"></td>
                <td th:text="${pessoa.registros.isEmpty() || pessoa.registros[0].horaSaida == null ? '-' : #temporals.format(pessoa.registros[0].horaSaida, 'dd/MM/yyyy HH:mm')}"></td>

                <td>
                    <div th:if="${registroAberto == null}">
                        <form th:action="@{/registros/entrada/{id}(id=${pessoa.id})}" method="post"
                              onsubmit="return confirm('Confirmar entrada?');">
                            <button type="submit">Registrar Entrada</button>
                        </form>
                    </div>

                    <div th:if="${registroAberto != null}">
                        <form th:action="@{/registros/saida/{id}(id=${registroAberto.id})}" method="post"
                              onsubmit="return confirm('Confirmar saída?');">
                            <button type="submit">Registrar Saída</button>
                        </form>
                    </div>
                </td>

                <!-- Observação -->
                <td>
                    <span class="obs-resumo" th:text="${#strings.length(pessoa.observacao) > 50 ? pessoa.observacao.substring(0,50) + '...' : pessoa.observacao}"></span>
                    <span class="obs-completa" th:text="${pessoa.observacao}" style="display:none;"></span>

                    <a href="#"
                       th:if="${!#strings.isEmpty(pessoa.observacao) and #strings.length(pessoa.observacao) > 50}"
                       class="ver-mais">ver mais</a>
                </td>

                <td>
                    <a th:href="@{/pessoas/{id}/historico(id=${pessoa.id})}">Histórico</a>
                </td>

                <td>
                    <a th:href="@{/pessoas/{id}/editar(id=${pessoa.id})}">Editar</a>
                </td>

                <td sec:authorize="hasAnyRole('SISTEMA', 'GERAL')">
                    <form th:action="@{/pessoas/{id}(id=${pessoa.id})}" th:method="delete"
                          onsubmit="return confirm('Tem certeza que deseja remover esta pessoa?')">
                        <button type="submit">Remover</button>
                    </form>
                </td>
            </tr>
            </tbody>
        </table>
    </section>
</main>

<script>
    const input = document.getElementById("busca");
    const tabela = document.getElementById("tabela-pessoas");

    let timeout;

    // Função genérica para atualizar a tabela
    function atualizarTabela(url) {
        fetch(url)
            .then(r => r.text())
            .then(html => {
                const tempDiv = document.createElement('div');
                // TRUQUE: Envolvemos o HTML em uma table para o navegador não remover o tbody
                tempDiv.innerHTML = '<table>' + html + '</table>';

                // Agora buscamos o tbody dentro da nossa tabela temporária
                const novoTbody = tempDiv.querySelector('tbody');

                if (novoTbody) {
                    tabela.innerHTML = novoTbody.innerHTML;
                }
            })
            .catch(error => console.error('Erro na busca:', error));
    }

    // Evento de Digitação (Busca)
    input.addEventListener("keyup", () => {
        clearTimeout(timeout);
        timeout = setTimeout(() => {
            const termo = encodeURIComponent(input.value);
            // Chama a URL de busca. Se o termo for vazio, o backend já trata (traz todos).
            atualizarTabela(`/pessoas/buscar?termo=${termo}`);
        }, 300);
    });

    // Botão Limpar
    document.getElementById("limpar-busca").addEventListener("click", function(e) {
        e.preventDefault();
        input.value = "";

        // Reutiliza a rota de busca com termo vazio para trazer a lista completa (fragmento)
        // em vez de carregar a página inteira novamente.
        atualizarTabela(`/pessoas/buscar?termo=`);
    });

    // Ver mais / ver menos (Mantido igual)
    document.addEventListener("click", function (e) {
        if (!e.target.classList.contains("ver-mais")) return;

        e.preventDefault();

        const td = e.target.closest("td");
        const resumo = td.querySelector(".obs-resumo");
        const completa = td.querySelector(".obs-completa");

        const expandido = completa.style.display === "block";

        if (expandido) {
            completa.style.display = "none";
            resumo.style.display = "inline";
            e.target.textContent = "ver mais";
        } else {
            completa.style.display = "block";
            resumo.style.display = "none";
            e.target.textContent = "ver menos";
        }
    });
</script>

</html>
