<!DOCTYPE html>
<html lang="pt-br" xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width"/>
    <title>Cadastrar entrada</title>
    <link rel="stylesheet" th:href="@{/css/estilo.css}" />
</head>

<body>
<header>
    <nav>
        <ul>
            <li><a th:href="@{/}"> Entrada e saída </a></li>
            <li><a th:href="@{/pessoas}"> Listar </a></li>
            <li><a th:href="@{/pessoas/novo}"> Novo </a></li>
        </ul>
    </nav>
</header>

<main>
    <section>
        <h1>Cadastro de Pessoas</h1>
    </section>

    <section>
        <div th:if="${erro}" style="color: white; background-color: #d9534f; padding: 10px; margin-bottom: 15px; border-radius: 4px;">
            <strong th:text="${erro}"></strong>
        </div>

        <div id="js-erro" style="display: none; color: white; background-color: #f0ad4e; padding: 10px; margin-bottom: 15px; border-radius: 4px;">
            <strong id="js-erro-msg"></strong>
        </div>

        <form th:action="@{/pessoas}" th:object="${pessoa}" method="post" id="pessoaForm">

            <input type="hidden" th:field="*{id}" />

            <div th:if="${!pessoa.novo}">
                <label>Código: </label>
                <input th:field="*{id}" readonly="readonly" />
            </div>

            <div>
                <label>CPF:</label>
                <input th:field="*{cpf}" id="cpf" placeholder="000.000.000-00" maxlength="14"/>
            </div>

            <div>
                <label>Identidade:</label>
                <input th:field="*{identidade}"/>
            </div>

            <div>
                <label>Nome: </label>
                <input th:field="*{nome}" required />
            </div>

            <div>
                <label>Telefone: </label>
                <input th:field="*{telefone}" id="telefone" placeholder="(00) 00000-0000"/>
            </div>

            <div>
                <label>Unidade:</label>
                <input th:field="*{unidade}" required />
            </div>

            <div>
                <label>Setor:</label>
                <input th:field="*{setor}" required />
            </div>

            <div>
                <label>Andar:</label>
                <input th:field="*{andar}" required />
            </div>

            <div>
                <label>Paciente:</label>
                <input th:field="*{paciente}" required />
            </div>

            <div>
                <label for="observacao">Observação:</label>
                <textarea th:field="*{observacao}" rows="4" cols="50"></textarea>
            </div>

            <div>
                <button type="submit">Salvar</button>
                <button type="button" id="limpar">Limpar</button>
            </div>
        </form>
    </section>

    <script>
        const cpfInput = document.getElementById('cpf');
        const telInput = document.getElementById('telefone');
        const form = document.getElementById('pessoaForm');
        const jsErroDiv = document.getElementById('js-erro');
        const jsErroMsg = document.getElementById('js-erro-msg');

        // --- MÁSCARA DE CPF ---
        cpfInput.addEventListener('input', e => {
            let value = e.target.value.replace(/\D/g, '');
            value = value.replace(/(\d{3})(\d)/, '$1.$2');
            value = value.replace(/(\d{3})(\d)/, '$1.$2');
            value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
            e.target.value = value;
        });

        // --- MÁSCARA DE TELEFONE (Extra) ---
        telInput.addEventListener('input', e => {
            let value = e.target.value.replace(/\D/g, '');
            value = value.replace(/^(\d{2})(\d)/g, '($1) $2');
            value = value.replace(/(\d)(\d{4})$/, '$1-$2');
            e.target.value = value;
        });

        // --- VALIDAÇÃO DE CPF REAL ---
        function validarCPF(cpf) {
            cpf = cpf.replace(/[^\d]+/g, '');
            if (cpf == '' || cpf.length != 11 || /^(\d)\1{10}$/.test(cpf)) return false;
            let add = 0;
            for (let i = 0; i < 9; i++) add += parseInt(cpf.charAt(i)) * (10 - i);
            let rev = 11 - (add % 11);
            if (rev == 10 || rev == 11) rev = 0;
            if (rev != parseInt(cpf.charAt(9))) return false;
            add = 0;
            for (let i = 0; i < 10; i++) add += parseInt(cpf.charAt(i)) * (11 - i);
            rev = 11 - (add % 11);
            if (rev == 10 || rev == 11) rev = 0;
            if (rev != parseInt(cpf.charAt(10))) return false;
            return true;
        }

        // --- INTERCEPTAR ENVIO DO FORMULÁRIO ---
        form.addEventListener('submit', function(e) {
            const cpfValue = cpfInput.value;

            // Só valida se o CPF estiver preenchido (já que RG é opcional)
            if (cpfValue.length > 0) {
                if (!validarCPF(cpfValue)) {
                    e.preventDefault(); // Impede o envio
                    jsErroMsg.textContent = "O CPF digitado é inválido. Por favor, confira os números.";
                    jsErroDiv.style.display = 'block';
                    cpfInput.focus();
                    return;
                }
            }
        });

        // Botão Limpar
        document.getElementById('limpar').addEventListener('click', function() {
            window.location.href = '/pessoas/novo';
        });
    </script>
</main>
</body>
</html>