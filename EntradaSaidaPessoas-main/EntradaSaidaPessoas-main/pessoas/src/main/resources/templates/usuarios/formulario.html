<!DOCTYPE html>
<html lang="pt-br" xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width"/>
    <title>Cadastro de Usuário</title>
    <link rel="stylesheet" th:href="@{/css/estilo.css}" />
</head>

<body>
<header>
    <nav>
        <ul>
            <li><a th:href="@{/}"> Entrada e saída </a></li>
            <li><a th:href="@{/pessoas}"> Listar Pessoas </a></li>
            <li><a th:href="@{/usuarios}"> Listar Usuários </a></li>
            <li sec:authorize="hasAnyRole('SISTEMA', 'GERAL')">
                <a th:href="@{/usuarios}"> Cadastro de Usuários </a>
            </li>

            <li sec:authorize="isAuthenticated()">
                <form th:action="@{/logout}" method="post" style="display:inline">
                    <button type="submit" style="background:none; border:none; color:white; cursor:pointer;">Sair</button>
                </form>
            </li>
        </ul>
    </nav>
</header>

<main>
    <section>
        <h1 th:text="${usuario.id == null ? 'Cadastro de Usuário' : 'Edição de Usuário'}"></h1>
    </section>

    <section>
        <div th:if="${erro}" style="color: white; background-color: #d9534f; padding: 10px; margin-bottom: 15px; border-radius: 4px;">
            <strong th:text="${erro}"></strong>
        </div>

        <div id="js-erro" style="display: none; color: white; background-color: #f0ad4e; padding: 10px; margin-bottom: 15px; border-radius: 4px;">
            <strong id="js-erro-msg"></strong>
        </div>

        <form th:action="@{/usuarios}" th:object="${usuario}" method="post" id="usuarioForm">

            <input type="hidden" th:field="*{id}" />

            <div th:if="${usuario.id != null}">
                <label>Código: </label>
                <input th:field="*{id}" readonly="readonly" style="background-color: #eee;" />
            </div>

            <div>
                <label>Nome Completo: </label>
                <input th:field="*{nomeCompleto}" required placeholder="Digite o nome do operador" />
            </div>

            <div>
                <label>CPF (Login):</label>
                <input th:field="*{cpf}" id="cpf" placeholder="000.000.000-00" maxlength="14" required/>
            </div>

            <div>
                <label>Senha:</label>
                <input type="password" th:field="*{senha}" id="senha"
                       th:required="${usuario.id == null}"
                       placeholder="Digite a senha de acesso"/>
                <small th:if="${usuario.id != null}" style="display: block; color: #666; margin-top: 5px;">
                    (Deixe em branco para manter a senha atual)
                </small>
            </div>

            <div th:if="${podeEscolherPerfil}">
                <label>Nível de Acesso:</label>
                <select th:field="*{perfil}">
                    <option value="ROLE_USER">Usuário Comum</option>
                    <option value="ROLE_SISTEMA">Administrador do Sistema</option>
                </select>
            </div>

            <input type="hidden" th:if="${!podeEscolherPerfil}" name="perfil" value="ROLE_USER" />

            <div style="margin-top: 20px;">
                <button type="submit">Salvar Usuário</button>
                <button type="button" id="limpar">Limpar</button>
            </div>
        </form>
    </section>

    <script>
        const cpfInput = document.getElementById('cpf');
        const form = document.getElementById('usuarioForm');
        const jsErroDiv = document.getElementById('js-erro');
        const jsErroMsg = document.getElementById('js-erro-msg');

        // --- MÁSCARA DE CPF ---
        cpfInput.addEventListener('input', e => {
            let value = e.target.value.replace(/\D/g, '');
            value = value.replace(/(\d{3})(\d)/, '$1.$2');
            value = value.replace(/(\d{3})(\d)/, '$1.$2');
            value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
            e.target.value = value;
        });

        // --- VALIDAÇÃO DE CPF ---
        function validarCPF(cpf) {
            cpf = cpf.replace(/[^\d]+/g, '');
            if (cpf == '' || cpf.length != 11 || /^(\d)\1{10}$/.test(cpf)) return false;
            let add = 0;
            for (let i = 0; i < 9; i++) add += parseInt(cpf.charAt(i)) * (10 - i);
            let rev = 11 - (add % 11);
            if (rev == 10 || rev == 11) rev = 0;
            if (rev != parseInt(cpf.charAt(9))) return false;
            add = 0;
            for (let i = 0; i < 10; i++) add += parseInt(cpf.charAt(i)) * (11 - i);
            rev = 11 - (add % 11);
            if (rev == 10 || rev == 11) rev = 0;
            if (rev != parseInt(cpf.charAt(10))) return false;
            return true;
        }

        form.addEventListener('submit', function(e) {
            const cpfValue = cpfInput.value;
            if (cpfValue.length > 0) {
                if (!validarCPF(cpfValue)) {
                    e.preventDefault();
                    jsErroMsg.textContent = "CPF inválido. Verifique os números.";
                    jsErroDiv.style.display = 'block';
                    cpfInput.focus();
                }
            }
        });

        // Botão Limpar
        document.getElementById('limpar').addEventListener('click', function() {
            window.location.href = '/usuarios/novo';
        });
    </script>
</main>
</body>
</html>